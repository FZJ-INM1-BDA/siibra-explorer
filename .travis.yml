language: node_js

os: linux
dist: xenial
node_js:
- 12

git:
  depth: 3

script: 'echo Running against $(node -v)'

jobs:
  include:

    - stage: Unit test frontend
      name: frontend unit test
      install:
      - npm i
      script:
      - npm run lint
      - npm test
      env:
      - NODE_ENV=test

    - stage: Unit test backend
      name: backend unit test
      before_install:
      - cd deploy
      install:
      - npm i
      script:
      - npm test
      env:
      - NODE_ENV=test
      - PORT=12234

    - stage: e2e
      # only triggered via API, where env can be overwritten
      # if: env(BROWSERSTACK_TEST_E2E) = 1
      name: e2e (with browserstack)
      install:
      - npm i
      - npm run build-aot
      script:
      - cd deploy && npm i
      - nohup node server.js &
      - sleep 5s
      - curl http://localhost:3000
      - cd ..
      - PROTRACTOR_SPECS=./src/navigating/*.e2e-spec.js BROWSERSTACK_TEST_NAME=e2e_navigating npm run e2e
      env:
      - ATLAS_URL=https://interactive-viewer-next.apps-dev.hbp.eu/
      - BROWSERSTACK_USERNAME=xiao33
      - secure: "YD2hDBnWzcMs9mTJCsKkJimd+mYKP8V1lTaCnxNvspJUxTuBWFmr8cvryIs9G9DhwgxkC3YL7hugsGkwMg6OIq27vLlo8mgoKS7/qrkWAJApGvDW4jc4CHpI2iE/ryrwG1bI3u9TuG0kSw+2sN/786LBgArlf5NbmwB9zmW4zyzjXXzSME34cwYdfEP96L2cob/uGiIj9YdaA1k3zfBhQQlp328i/xzYbIAcwfIia1AKYh/wgCzj+yfWDQ0Rtg9VcI2JiNfcbzMCgvDEBzshgeXuubFd9GPqPsc8zJhYqAi/15ge+WiB8R50MnZsYHO39JJihQzKz6WxIZQDeOQ2xd600NhFFLg6WPdE3jxAyENouTAd+0zJgXEeUU71YBDBl6RViagf8k7eOe9oMPW5ZlevdD3vcI8BC/qUL6Evye8QDDNi0s8gbIvcnJl5QMRBpeYcm/QaRUow1YeJobpccj/3tb7qTbc7T4Rha/NRBNhbhp/WzDSO/BUSEtpgJ3YwSEPTiEeSocTRT8ylnhEtBB70h4vQSClV73lW4vn7WjdZUTRACdxFNJ1MteQJ+3bgzyWMhDtdQo6BSz2UxF0mQFayAu2p9j0+MbB7x2zW9tksSw+6B6EjzPhQw6eOs2K0+syxWg09MTW1Fy6n0Zgchn0RWSnEPqPvss6kB2pkAR4="
      - HBP_CLIENTID=8ede22fe-e993-4da0-b352-221bb0ba8769
      - secure: "CwMybsdZOeUETkUIvleaN0fFWPxQ8Kkw8SP+N3H1+CypQBbvtUW7nfXjSQvqZFgSPUsYFITywwjdH+MP0HD3tdO4qkE+6IgNvRYxfo5gmaSC+uYQRZNeG+fYUqf7XLUD6yL44rI6UPaSrzumIlNeO3g3ArXTgalIKL8J7mGwinU9uGc2um5dEFFSL09cw2y7QgJryCFAn+/Ug6fElt7+aBCitRfxJak1tf1rwj7z/M7qLFZc3+ZcDI3wa/G2pZn4nRZj17K/Q8l5+vYIu7RvXSo/ObOL2GekyQWmmehvjqwWVQmTTIdt+kXaoAFLV6x8FVNnxAOLZyDOmBgHBFN9Zp1z94uHiY/9UXh6e/z6483tNcf7E7yM7rD2i6NY2rv1xe7k6cs87BddcUJuqsieQadH0mwEviVwQAHyytIsqm8a7kdw6ACmK0dt1DSd2NMXC+NnziQes3b0r2omzVU0fWHWs2QV+CPAwCtCCi4GWpT9a4D6vsj95stcyUkWZRyyeuq9xJ7NLc8oVY/PtJgMqid8a9jEzpFV2FKts817j49PumU7xXVjzs9ZhyOA8ZxZCOqrV0JzHMOjVdp9NcnHMTh/dySMjW1su1uKMJ+hKvyH5PyUvwJS18rxpRI2Gfp0v4lZRtxsyP+/9RWiVJriK4AOGVAPufRq5iU2s/9MfLg="
      - secure: "uOEwvjX6PdkUlNzSO9NQLNI83f35bUTomb/n5s89hzvQCoKtfPdqWCSFjt7jpsfdEnBdwclsL+0wJ+kONeHHsrTtb4CKQhlg9YK6wMQEiKik0UoVpCThi3zxMM9vXHj7qr7QZQl1UMDMxdw9DhzBUgr17x5OK4uzoIA0wJ312DSu/O1E8aRgWJbcTP7qmFcRbIC78Vc3xijn23svX/aLC6AO4sllDnhqMPvz/VCgVc9fdnn0v7VsrT5ozUFvFWJGsU0S2ZcLaUjacQFygzUsTNu/5hUMSr5SfG6CZEKp6IGrri9RaaXWq8PZtBpIn7N0WhxHWLjDhuZS/UmeMqfryWgaM8DbSGo/YnVQ2pOR9tUkFKPJu/swE0/uYS1zd1hGcbtw1LEey1fxNWaTu5/MINyuSg515lVNGC7qmENlmAD0dbraloXPDumvdYwh36RzYUtURX8ID4epRDshQfojkZVmYHsSiEvjeNinr30cFYqre0dYh3JhkbbozZOtix2PIeifIzlRumbuePFrk5aDYanENtINd79XxL4PRB8ofgdMCrHje/oOPwbVF+XYVi5prBsSfX1AA8IkhxY87pC127A0N8w/ThPgkruN/6zJLZUySj9I42HzZvoc9iESuERf4oTLqc3Z6PVvX4qstb3jn7nxzzMeLA53bj7zXgxYu4c="
      
addons:
  browserstack:
    username: "xiao33"
    access_key:
      secure: "j0NdVLyNwm1gDclEeE/xYrXAYiYAlx3HQxNRHMFhJyFml5R22spEMTwrTRl/vzyhv1FwfJAKfh4qbOn99cZ5Dzm7fWc8+Kq1zpp/1PRTzbFaLluJkV1wCwoODZkzmSVPj43M6070FhCJvOfe5VRUV440CgZH8IWRm7xaxRnN/MVyFMErMV/GIczEBB7D7E4mMhe6c9pBxjmojDDP4rGvKLGOYU7oVQKgZtbHtP/BxjQ7uzMysdTHZGZ/2c/XW/2bKVSADi4vFzge5PMVF3nSH+vzA09ro180Q5aoaek4XQPoIza0s0cqtqkbvkbJ+lWRE+Q7wJDhQLM4WNx5GX3fegJiqJRT7272EgGAUy6C+e2F+D5nPucf3w6Uov9vBn5zZjbfXdNah3GZEXOTRNAVzstySiwiZe7/f4bk0vWIiEhHC+iutjn8skMxFnuw2eM3SJ5ayjxskHOdRux+1fuDya32ctx8y9a3XLhuFcuGTaeMSAn5Dw5qOlI5Qoc+xRSARoRWKmlEuxTUudD0e+b8xqfZgmOP7D3GZ6QX2W4yFrOLGqUzEySHr8hxxzhIlfwSvVdJ15AtN2AtPFQYQXb7M+XX1L7fr39Z/5ctr7DDgljSE3F2U5ofyWV2hh54aGMBQe76cZfVzF4bi98X3r6u0b3Knyti2pvx5jIoxP46nOA="
    only: localhost,3000,0
    forcelocal: true
  