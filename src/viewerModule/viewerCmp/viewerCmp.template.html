<div iav-media-query class="position-absolute w-100 h-100" #media="iavMediaQuery">
  <ng-container *ngTemplateOutlet="viewerTmpl">
  </ng-container>

  <div class="floating-ui">

    <ng-template [ngIf]="(media.mediaBreakPoint$ | async) < 2">
      <div class="logo-container">
        <logo-container></logo-container>
      </div>
    </ng-template>
    
    <ng-template [ngIf]="(media.mediaBreakPoint$ | async) < 2">
      <div floatingMouseContextualContainerDirective>
        <mouseover-info
          class="contextual-block">
        </mouseover-info>
      </div>
    </ng-template>
  </div>
</div>

<!-- master draw container -->
<ng-template [ngIf]="view$ | async" let-view>
  
  <iav-layout-fourcorners class="sxplr-pe-none">

    <ng-template #sidebarContentTmpl>
      <!-- default mode top left tmpl -->
      <ng-template [ngTemplateOutlet]="defaultMainContentTopLeft"
        [ngTemplateOutletContext]="{
          view: view
        }">
      </ng-template>

      <!-- special mode -->
      <ng-template [ngIf]="view.viewerMode" let-mode>
        <ng-template [ngTemplateOutlet]="specialModeTopLeftTmpl"
          [ngTemplateOutletContext]="{ mode: mode, view: view }">
        </ng-template>
      </ng-template>
    </ng-template>

    <!-- top left -->
    <div iavLayoutFourCornersTopLeft>

      <div 
        class="left-panel-container mt-2 vw-col-10 vw-col-sm-10 vw-col-md-5 vw-col-lg-4 vw-col-xl-3 vw-col-xxl-2 z-index-1 menu-container"
        [ngClass]="{
          'vw-col-10-nm vw-col-sm-10-nm vw-col-md-5-nm vw-col-lg-4-nm vw-col-xl-3-nm vw-col-xxl-2-nm': !view.halfSidenavExpanded
        }">
        <ng-template [ngTemplateOutlet]="sidebarContentTmpl"></ng-template>

      </div>
      
      <button mat-raised-button
        [color]="view.halfSidenavExpanded ? 'primary' : 'primary'"
        class="sxplr-tab"
        (click)="controlHalfNav(!view.halfSidenavExpanded)">
        
        <mat-icon>{{ view.halfSidenavExpanded ? 'chevron_left' : 'chevron_right' }}</mat-icon>
        
      </button>


    </div>

    <!-- top right -->
    <div iavLayoutFourCornersTopRight class="ws-no-wrap">

      
      <ng-template [ngTemplateOutlet]="minDefaultMainContentTopRight">
      </ng-template>
      
    </div>

    <div iavLayoutFourCornersBottomLeft>
      <mat-card class="express-atlas-selection sxplr-muted hoverable sxplr-custom-cmp"
        mat-ripple
        [matMenuTriggerFor]="expressMenu"
        >
        <markdown-dom
          [markdown]="{
            atlas: view.selectedAtlas,
            template: view.selectedTemplate,
            parcellation: view.selectedParcellation,
            regions: view.selectedRegions
          } | atprToMd">
        </markdown-dom>
      </mat-card>
    </div>

    <!-- buttom right -->
    <div iavLayoutFourCornersBottomRight>
      <div class="leap-control-wrapper">
        <div leap-control-view-ref></div>
      </div>
    </div>
  </iav-layout-fourcorners>

  <mat-menu #expressMenu="matMenu"
    available-atp
    #availableATP="availableATP">
    <ng-template [ngIf]="availableATP.view$ | async" let-availview>
      <button mat-menu-item [matMenuTriggerFor]="speciesSubMenu">species</button>
      <button mat-menu-item [matMenuTriggerFor]="spaceSubMenu">reference space</button>
      <button mat-menu-item [matMenuTriggerFor]="parcSubMenu">reference parcellation</button>

      
      <mat-menu #speciesSubMenu="matMenu">
        <ng-template ngFor [ngForOf]="availview.atlases" let-atlas>
          <button mat-menu-item
            (click)="availableATP.selectATP('atlasId', atlas.id)">
            <mat-icon fontSet="fas" [fontIcon]="atlas?.id === view.selectedAtlas?.id ? 'fa-circle' : 'fa-none'"></mat-icon>
            <span>
              {{ atlas.species }}
            </span>
          </button>
        </ng-template>
      </mat-menu>
      
      <mat-menu #spaceSubMenu="matMenu">
        <ng-template ngFor [ngForOf]="availview.templates" let-template>
          <button mat-menu-item
            (click)="availableATP.selectATP('templateId', template.id)">
            <mat-icon fontSet="fas" [fontIcon]="template?.id === view.selectedTemplate?.id ? 'fa-circle' : 'fa-none'"></mat-icon>
            <span>
              {{ template.shortName || template.name }}
            </span>
          </button>
        </ng-template>
      </mat-menu>
      
      <mat-menu #parcSubMenu="matMenu">
        
        <ng-template ngFor [ngForOf]="availview.groupParcs" let-grp>
          <label class="menu-label">{{ grp.name }}</label>
          <ng-template ngFor [ngForOf]="grp.parcellations" let-parcellation>
            <button mat-menu-item
              (click)="availableATP.selectATP('parcellationId', parcellation.id)">
              <mat-icon fontSet="fas" [fontIcon]="parcellation?.id === view.selectedParcellation?.id ? 'fa-circle' : 'fa-none'"></mat-icon>
              <span>
                {{ parcellation.shortName || parcellation.name }}
              </span>
            </button>
          </ng-template>
          <mat-divider></mat-divider>
        </ng-template>

        <ng-template ngFor [ngForOf]="availview.noGroupParcs" let-parcellation>
          <button mat-menu-item
            (click)="availableATP.selectATP('parcellationId', parcellation.id)">
            <mat-icon fontSet="fas" [fontIcon]="parcellation?.id === view.selectedParcellation?.id ? 'fa-circle' : 'fa-none'"></mat-icon>
            <span>
              {{ parcellation.shortName || parcellation.name }}
            </span>
          </button>
        </ng-template>
      </mat-menu>
    </ng-template>
  </mat-menu>

</ng-template>



<!-- top left -->
<!-- default top left -->
<ng-template #defaultMainContentTopLeft
  let-view="view">

  <sxplr-vertical-bread-crumb class="sxplr-d-block sxplr-overflow-y-auto mat-elevation-z1"
    [viewerLoaded]="viewerLoaded"
    *ngIf="view.useViewer"
    (show)="controlHalfNav(true)">
  </sxplr-vertical-bread-crumb>

</ng-template>


<!-- special mode top left -->
<ng-template #specialModeTopLeftTmpl let-mode="mode" let-view="view">

  <div class="sxplr-pe-all">
    <ng-container [ngSwitch]="mode">
      <!-- catch case where annotation mode is activated -->
      <ng-template [ngSwitchCase]="ARIA_LABELS.VIEWER_MODE_ANNOTATING">
        <mat-card class="sxplr-m-1">
          <mat-card-content>
            Annotation no longer has a special mode. Please contact us on how you reached here. We will try to fix the bug ASAP.
          </mat-card-content>
        </mat-card>
      </ng-template>
      
      <!-- key frame mode -->
      <ng-template [ngSwitchCase]="ARIA_LABELS.VIEWER_MODE_KEYFRAME">
        <mat-card class="sxplr-m-1">
          <mat-card-content>
            <key-frame-controller></key-frame-controller>
          </mat-card-content>
        </mat-card>
      </ng-template>

      <!-- VOI mode -->
      <ng-template [ngSwitchCase]="FOCUS_VIEW_LABELS.VOI">
        <ng-template [ngIf]="view.selectedFeature" let-feature>
          <div class="sxplr-d-none"
            feature-view-base
            [feature]="feature"
            #fvb="featureViewBase"></div>

          <ng-template [ngIf]="fvb.view$ | async" let-fView>
            <!-- n.b viewerLoaded conditional ensures that this component is rerendered -->
            <!-- thereby loads the VOI -->
            <ng-template [ngIf]="viewerLoaded && fView.voi" let-voi>
              <mat-card class="sxplr-m-1">
                <mat-card-header>
                  <mat-card-title class="with-controls">
                    <span>
                      Previewing overlay volume
                    </span>
                    <button mat-icon-button
                      color="warn"
                      [matTooltip]="view.labels.RETURN_TO_DETAIL"
                      (click)="exitSpecialViewMode()">
                      <mat-icon>unfold_more</mat-icon>
                    </button>
                    <button mat-icon-button
                      color="warn"
                      [matTooltip]="view.labels.DISMISS"
                      (click)="clearShownFeature(); exitSpecialViewMode()">
                      <mat-icon>close</mat-icon>
                    </button>
                  </mat-card-title>
                </mat-card-header>
                <mat-card-content>

                  <mat-divider></mat-divider>

                  <ng-layer-ctl
                    [ng-layer-ctl-name]="voi.ngVolume.url"
                    [ng-layer-ctl-format]="voi.ngVolume.format"
                    [ng-layer-ctl-src]="voi.ngVolume.url"
                    [ng-layer-ctl-transform]="voi.ngVolume.transform"
                    [ng-layer-ctl-info]="voi.ngVolume.info"
                    [ng-layer-ctl-opacity]="1.0"
                    [ng-layer-ctl-meta]="voi.ngVolume.meta"
                    [ng-layer-ctl-show]="true">
                  </ng-layer-ctl>
                  <mat-form-field class="flex-grow-3">
                      <mat-label>
                          Visualize with a model
                      </mat-label>
                      <mat-select #vizSelect="matSelect">
                          <mat-option disabled selected>Select a model</mat-option>
                          <mat-option
                              *ngFor="let aVoi of fView.additionalVois"
                              [value]="aVoi.id">
                              {{ aVoi.name }}
                          </mat-option>
                      </mat-select>
                  </mat-form-field>
                  
                  <ng-template ngFor [ngForOf]="fView.additionalVois" let-aVoi>
                      <ng-template [ngIf]="aVoi.id === vizSelect.value">
                          <button mat-icon-button
                              [matTooltip]="view.labels.DETAILS"
                              [sxplr-dialog]="DoiTemplate"
                              [sxplr-dialog-size]="null"
                              [sxplr-dialog-data]="{
                                  title: aVoi.name,
                                  desc: aVoi.desc,
                                  contributors: aVoi.contributors | dedup, 
                                  actions: aVoi.link | mapToProperty : 'href' | dedup
                              }">
                              <mat-icon>info</mat-icon>
                          </button>
                      </ng-template>
                  </ng-template>
                  <button mat-icon-button color="warn"
                      (click)="vizSelect.value = null"
                      [disabled]="!vizSelect.value">
                      <mat-icon>clear</mat-icon>
                  </button>
                  
                  <ng-template ngFor [ngForOf]="fView.additionalVois" let-aVoi>
                      <ng-template [ngIf]="aVoi.id === vizSelect.value">
                          <mat-divider></mat-divider>
                          <ng-layer-ctl
                              [ng-layer-ctl-name]="SXPLR_PREFIX + aVoi.ngVolume.url"
                              [ng-layer-ctl-src]="aVoi.ngVolume.url"
                              [ng-layer-ctl-transform]="aVoi.ngVolume.transform"
                              [ng-layer-ctl-meta]="aVoi.ngVolume.meta"
                              [ng-layer-ctl-insert-index]="aVoi.ngVolume.insertIndex"
                              [ng-layer-ctl-opacity]="1.0">
                          </ng-layer-ctl>
                      </ng-template>
                  </ng-template>
                </mat-card-content>
              </mat-card>
            </ng-template>
          </ng-template>
        </ng-template>
      </ng-template>

      <!-- point assignment -->
      <ng-template [ngSwitchCase]="FOCUS_VIEW_LABELS.GEOMETRY">
        <mat-card class="sxplr-m-1">
          <mat-card-header>
            <mat-card-title class="with-controls">
              <span>
                Assignment
              </span>
              <button mat-icon-button
                color="warn"
                [matTooltip]="view.labels.DISMISS"
                (click)="clearPoint(); exitSpecialViewMode()">
                <mat-icon>close</mat-icon>
              </button>
            </mat-card-title>
          </mat-card-header>
          <sxplr-point-assignment
            [point]="view.selectedPoint"
            [template]="view.selectedTemplate"
            [parcellation]="view.selectedParcellation">
          </sxplr-point-assignment>
        </mat-card>
      </ng-template>
      
      <!-- connectivity mode -->
      <ng-template [ngSwitchCase]="FOCUS_VIEW_LABELS.CONNECTIVITY">
        <mat-card class="sxplr-m-1">
          <mat-card-header>
            <mat-card-title>
              Regional Connectivity
            </mat-card-title>
          </mat-card-header>
          <mat-card-content>
            <ng-template #noParcTmpl>
              Parcellation must be selected to show regional connectivity
            </ng-template>
            <ng-template #noRegTmpl>
              Region must be selected to show regional connectivity
            </ng-template>
            <ng-template [ngIf]="view.selectedParcellation" let-parcellation [ngIfElse]="noParcTmpl">
              <ng-template [ngIf]="(view.selectedRegions || [])[0]" let-region [ngIfElse]="noRegTmpl">

                <tpbr-viewer
                  [tpbr-concept]="{
                    parcellation: parcellation,
                    region: region
                  }"
                  [parcellation]="parcellation"
                  [region]="region"
                  tpbr-category
                  #tpbrCategory="tpbrCategory"
                  >
                </tpbr-viewer>
                <ng-template [ngIf]="tpbrCategory.cateogryCollections$ | async | keyvalue | filterCategory : ['connectivity']" let-connectivity>
                  <ng-template ngFor [ngForOf]="connectivity" let-conn>
                    <ng-template [ngIf]="conn.value" let-connType>
                      <sxplr-features-connectivity-browser
                        [sxplr-features-connectivity-browser-parcellation]="parcellation"
                        [region]="region"
                        [accordionExpanded]="true"
                        [types]="connType"
                        >
                      </sxplr-features-connectivity-browser>
                    </ng-template>
                  </ng-template>
                </ng-template>
              </ng-template>
            </ng-template>
          </mat-card-content>
        </mat-card>
      </ng-template>

      <!-- default -->
      <ng-template ngSwitchDefault>
        <mat-card class="sxplr-m-1">
          <mat-card-content>
            <span class="pe-all">View mode {{ mode }} does not have side nav registered.</span>
          </mat-card-content>
        </mat-card>
      </ng-template>
    </ng-container>
  
  </div>
</ng-template>


<!-- top right -->
<!-- default top right -->
<ng-template #minDefaultMainContentTopRight>

  <!-- signin banner at top right corner -->
  <top-menu-cmp class="mt-3 mr-2 d-inline-block"
    [ismobile]="(media.mediaBreakPoint$ | async) > 3"
    [viewerLoaded]="viewerLoaded">
  </top-menu-cmp>

</ng-template>

<!-- viewer tmpl -->
<ng-template #viewerTmpl>
  <div class="position-absolute w-100 h-100 z-index-1"
    ctx-menu-host
    [ctx-menu-host-tmpl]="viewerCtxMenuTmpl">
    <viewer-wrapper
      (viewer-event)="handleViewerCtxEvent($event)">
    </viewer-wrapper>

  </div>
</ng-template>


<!-- region tmpl placeholder -->
<ng-template #regionPlaceholderTmpl>
  <div class="placeholder-region-detail bs-border-box ml-15px-n mr-15px-n mat-elevation-z4">
    <span class="text-muted">
      Select a region by clicking on the viewer or search from above
    </span>
  </div>
</ng-template>

<!-- context menu template -->
<ng-template #viewerCtxMenuTmpl let-tmplRefs="tmplRefs">
  <mat-card
    [iav-key-listener]="[{type: 'keydown', target: 'document', capture: true, key: 'Esc'}]"
    (iav-key-event)="disposeCtxMenu()"
    (iav-outsideClick)="disposeCtxMenu()">
    
    <mat-card-content class="context-menu-container">
      <div *ngFor="let tmplRef of tmplRefs"
        [ngStyle]="{ order: tmplRef.order || 0 }">

        <ng-template [ngIf]="tmplRef.tmpl"
          [ngIfElse]="fallbackTmpl"
          [ngTemplateOutlet]="tmplRef.tmpl"
          [ngTemplateOutletContext]="{ $implicit: tmplRef.data }">
        </ng-template>
          
        <ng-template #fallbackTmpl>
          {{ tmplRef.data.message || 'test' }}
        </ng-template>
      </div>

    </mat-card-content>

  </mat-card>
</ng-template>

<ng-template #lastViewedPointTmpl let-data>
  
  <mat-divider></mat-divider>

  <mat-list class="sxplr-p-0">
    <mat-list-item>
      Last selected spatial object
    </mat-list-item>
  </mat-list>

  <mat-action-list class="sxplr-p-0">
    <ng-template [ngIf]="data?.point">

      <button mat-list-item (click)="selectPoint(data, data.template)">
        <span matListItemIcon>
          <i class="fas fa-history"></i>
        </span>
    
        <!-- <span matListItemLine class="text-muted">Last selected spatial object</span> -->
        <span matListItemLine>{{ data.point | nmToMm | numbers | addUnitAndJoin : '' }} (mm)</span>
        <span matListItemLine class="text-muted">Point</span>
        <span matListItemLine class="text-muted">{{ data.template.name }}</span>
        
      </button>
    </ng-template>

    <ng-template [ngIf]="data?.face && data?.vertices">

      <button mat-list-item (click)="selectPoint(data, data.template)">
        <span matListItemIcon>
          <i class="fas fa-history"></i>
        </span>
    
        <span matListItemLine>
          Face Index: {{ data.face }}, Vertices Index: {{ data.vertices | addUnitAndJoin : '' }}
        </span>
        <span matListItemLine class="text-muted">
          Mesh Face
        </span>
        <span matListItemLine class="text-muted">{{ data.template.name }}</span>
        
      </button>
    </ng-template>
  </mat-action-list>

</ng-template>

<!-- viewer status ctx menu -->
<ng-template #viewerStatusCtxMenu let-data>
  <ng-template [ngIf]="data.context" let-context>

    <!-- ref space & position -->
    <ng-container [ngSwitch]="context.viewerType">

      <!-- volumetric i.e. nehuba -->
      <ng-container *ngSwitchCase="'nehuba'">
        <mat-card>
          <mat-card-header>
            <mat-card-title>
              {{ context.payload.mouse.real | nmToMm | numbers | addUnitAndJoin : '' }} (mm)
            </mat-card-title>
            <mat-card-subtitle>
              Point in {{ data.metadata.template.name }}
            </mat-card-subtitle>
          </mat-card-header>
          <mat-card-actions>
            <button mat-icon-button
              matTooltip="Check the assignment of this point in the current reference atlas"
              (click)="selectPoint({ point: context.payload.mouse.real }, data.metadata.template)">
              <mat-icon>assessment</mat-icon>
            </button>
            <button mat-icon-button
              matTooltip="Bookmark this point"
              (click)="bookmarkPoint({ point: context.payload.mouse.real }, data.metadata.template)">
              <mat-icon>bookmark</mat-icon>
            </button>
          </mat-card-actions>
        </mat-card>

      </ng-container>

      <ng-container *ngSwitchCase="'threeSurfer'">

        <ng-template [ngIf]="context.payload?.faceIndex" let-faceIndex>
          <ng-template [ngIf]="context.payload?.vertexIndices" let-vertexIndices>
            <mat-action-list class="sxplr-p-0">
              <button mat-list-item
                (click)="selectPoint({ face: faceIndex, vertices: vertexIndices }, data.metadata.template)"
                disabled>
                
                <span matListItemIcon>
                  <i class="fas fa-map"></i>  
                </span>
                
                <span matListItemLine>
                  Face Index: {{ faceIndex }}, Vertices Index: {{ vertexIndices | addUnitAndJoin : '' }}
                </span>
                <span matListItemLine class="text-muted">
                  Mesh Face (Not selectable for now)
                </span>
                <span matListItemLine class="text-muted">
                  {{ data.metadata.template.name }}
                </span>
              </button>
            </mat-action-list>

          </ng-template>
        </ng-template>
        
      </ng-container>

      <ng-container *ngSwitchDefault>
        DEFAULT
      </ng-container>
    </ng-container>
  </ng-template>
</ng-template>


<!-- viewer state hover ctx menu -->
<ng-template #viewerStatusRegionCtxMenu let-data>
  <!-- hovered ROIs -->
  <ng-template ngFor [ngForOf]="data.metadata.hoveredRegions" let-region>

    <mat-action-list class="sxplr-p-0">
      <button mat-list-item (click)="$event.ctrlKey ? toggleRoi(region) : selectRoi(region)">
        <span matListItemIcon>
          <i class="fas fa-brain"></i>  
        </span>
        
        <span matListItemLine>
          {{ region.name }}
        </span>
        <span matListItemLine class="text-muted">
          Brain region
        </span>
      </button>
    </mat-action-list>

  </ng-template>
</ng-template>

<!-- template for single feature modal -->
<ng-template #focusFeatureDialogTmpl let-context>
    <sxplr-feature-view [feature]="context.feature">
    </sxplr-feature-view>
    <div mat-dialog-actions align="end">
        <button mat-button mat-dialog-close #closeBtn="matDialogClose">
            Close
        </button>
    </div>
</ng-template>
