<div iav-media-query class="position-absolute w-100 h-100" #media="iavMediaQuery">
  <ng-container *ngTemplateOutlet="viewerTmpl">
  </ng-container>

  <div class="floating-ui">

    <ng-template [ngIf]="(media.mediaBreakPoint$ | async) < 2">
      <div class="logo-container">
        <logo-container></logo-container>
      </div>
    </ng-template>
    
    <ng-template [ngIf]="(media.mediaBreakPoint$ | async) < 2">
      <div floatingMouseContextualContainerDirective>
        <mouseover-info
          class="contextual-block">
        </mouseover-info>
      </div>
    </ng-template>
  </div>
</div>

<!-- master draw container -->
<ng-template [ngIf]="view$ | async" let-view>
  
  <iav-layout-fourcorners class="sxplr-pe-none">

    <!-- top left -->
    <div iavLayoutFourCornersTopLeft class="align-items-start d-inline-flex">

      <!-- special mode -->
      <ng-template [ngIf]="view.viewerMode" let-mode [ngIfElse]="defaultTopLeftTmpl">
        <ng-template [ngTemplateOutlet]="specialModeTopLeftTmpl"
          [ngTemplateOutletContext]="{ mode: mode, view: view }">
        </ng-template>
      </ng-template>

      <!-- default mode top left tmpl -->
      <ng-template #defaultTopLeftTmpl>
        <ng-template [ngTemplateOutlet]="defaultMainContentTopLeft"
          [ngTemplateOutletContext]="{
            view: view
          }">
        </ng-template>
      </ng-template>
    </div>

    <!-- top right -->
    <div iavLayoutFourCornersTopRight class="ws-no-wrap">

      <!-- exit special mode -->
      <ng-template [ngIf]="view.viewerMode" let-mode [ngIfElse]="defaultTopRightTmpl">
        <ng-template [ngTemplateOutlet]="specialTopRightTmpl"
          [ngTemplateOutletContext]="{
            mode: mode
          }">
        </ng-template>
      </ng-template>
      
      <!-- default mode top right tmpl -->
      <ng-template #defaultTopRightTmpl>
        <ng-template [ngTemplateOutlet]="minDefaultMainContentTopRight">
        </ng-template>
      </ng-template>
    </div>

    <!-- buttom right -->
    <div iavLayoutFourCornersBottomRight>
      <div class="leap-control-wrapper">
        <div leap-control-view-ref></div>
      </div>
    </div>
  </iav-layout-fourcorners>

</ng-template>



<!-- top left -->
<!-- default top left -->
<ng-template #defaultMainContentTopLeft
  let-view="view">

  <div class="mt-2 d-inline-block vw-col-10 vw-col-sm-10 vw-col-md-5 vw-col-lg-4 vw-col-xl-3 vw-col-xxl-2 z-index-1 menu-container"
    [ngClass]="{
      'vw-col-10-nm vw-col-sm-10-nm vw-col-md-5-nm vw-col-lg-4-nm vw-col-xl-3-nm vw-col-xxl-2-nm': !view.halfSidenavExpanded
    }">
    
    <sxplr-vertical-bread-crumb class="sxplr-d-block sxplr-overflow-y-auto">
    </sxplr-vertical-bread-crumb>

    <mat-card sxplr-slide-in [state]="!!view.selectedFeature">
      <sxplr-feature-view
        *ngIf="view.selectedFeature"
        [feature]="view.selectedFeature">
      </sxplr-feature-view>
    </mat-card>
    
    <mat-card sxplr-slide-in [state]="!!view.selectedPoint"
      class="pe-all">
      <ng-template [ngIf]="!!view.selectedPoint">
        <ng-template [ngTemplateOutlet]="selectedPointTmpl"
          [ngTemplateOutletContext]="{view: view}">
        </ng-template>
      </ng-template>
    </mat-card>
  </div>
  
  <sxplr-tab *ngIf="!!view.selectedTemplate"
    [sxplr-tab-icon]="view.halfSidenavExpanded ? 'fas fa-chevron-left' : 'fas fa-chevron-right'"
    sxplr-tab-color="primary"
    (sxplr-tab-click)="controlHalfNav(!view.halfSidenavExpanded)">
  </sxplr-tab>

</ng-template>


<!-- special mode top left -->
<ng-template #specialModeTopLeftTmpl let-mode="mode" let-view="view">
  
  <mat-card class="mt-2 d-inline-block vw-col-10 vw-col-sm-10 vw-col-md-5 vw-col-lg-4 vw-col-xl-3 vw-col-xxl-2 z-index-1 menu-container"
    [ngClass]="{
      'vw-col-10-nm vw-col-sm-10-nm vw-col-md-5-nm vw-col-lg-4-nm vw-col-xl-3-nm vw-col-xxl-2-nm': !view.halfSidenavExpanded
    }">
    <ng-container [ngSwitch]="mode">
      <annotation-list class="pe-all" *ngSwitchCase="ARIA_LABELS.VIEWER_MODE_ANNOTATING">
      </annotation-list>
      <key-frame-controller class="pe-all" *ngSwitchCase="ARIA_LABELS.VIEWER_MODE_KEYFRAME">
      </key-frame-controller>
      <span *ngSwitchDefault>View mode {{ mode }} does not have side nav registered.</span>
    </ng-container>

  </mat-card>
  <ng-template [ngIf]="view$ | async" let-view>

    <div class="special-mode-topleft-wrapper">

      <ng-container [ngSwitch]="mode">
        <!-- annotating top left -->
        <ng-template [ngSwitchCase]="ARIA_LABELS.VIEWER_MODE_ANNOTATING">
          <sxplr-tab
            sxplr-tab-icon="fas fa-list"
            sxplr-tab-color="primary"
            (sxplr-tab-click)="controlHalfNav(!view.halfSidenavExpanded)"
            [sxplr-tab-badge]="toolPanel?.annBadges$ | async">
          </sxplr-tab>
    
          <annotating-tools-panel class="leave-me-alone"
            #toolPanel="annoToolsPanel">
          </annotating-tools-panel>
        </ng-template>
  
        <ng-template [ngSwitchCase]="ARIA_LABELS.VIEWER_MODE_KEYFRAME">
          <sxplr-tab
            sxplr-tab-icon="fas fa-play"
            sxplr-tab-color="primary"
            (sxplr-tab-click)="controlHalfNav(!view.halfSidenavExpanded)">
          </sxplr-tab>
        </ng-template>
      </ng-container>
    </div>
  </ng-template>
</ng-template>


<!-- top right -->
<!-- default top right -->
<ng-template #minDefaultMainContentTopRight>

  <!-- signin banner at top right corner -->
  <top-menu-cmp class="mt-3 mr-2 d-inline-block"
    [ismobile]="(media.mediaBreakPoint$ | async) > 3"
    [viewerLoaded]="viewerLoaded">
  </top-menu-cmp>

</ng-template>


<!-- special mode top right -->
<ng-template #specialTopRightTmpl let-mode="mode">
  <mat-card class="mat-card-sm pe-all m-4">
    <mat-card-header>
      <mat-card-subtitle>
        <span>
          {{ mode }}
        </span>
        
        <button mat-icon-button
          color="warn"
          (click)="exitSpecialViewMode()">
          <i class="fas fa-times"></i>
        </button>
      </mat-card-subtitle>
    </mat-card-header>
    <mat-card-content>
      
    </mat-card-content>
  </mat-card>
</ng-template>

<!-- viewer tmpl -->
<ng-template #viewerTmpl>
  <div class="position-absolute w-100 h-100 z-index-1"
    ctx-menu-host
    [ctx-menu-host-tmpl]="viewerCtxMenuTmpl">
    <viewer-wrapper
      (viewer-event)="handleViewerCtxEvent($event)">
    </viewer-wrapper>

  </div>
</ng-template>


<!-- region tmpl placeholder -->
<ng-template #regionPlaceholderTmpl>
  <div class="placeholder-region-detail bs-border-box ml-15px-n mr-15px-n mat-elevation-z4">
    <span class="text-muted">
      Select a region by clicking on the viewer or search from above
    </span>
  </div>
</ng-template>

<!-- context menu template -->
<ng-template #viewerCtxMenuTmpl let-tmplRefs="tmplRefs">
  <mat-card
    [iav-key-listener]="[{type: 'keydown', target: 'document', capture: true, key: 'Esc'}]"
    (iav-key-event)="disposeCtxMenu()"
    (iav-outsideClick)="disposeCtxMenu()">
    
    <mat-card-content class="context-menu-container">
      <div *ngFor="let tmplRef of tmplRefs"
        [ngStyle]="{ order: tmplRef.order || 0 }">

        <ng-template [ngIf]="tmplRef.tmpl"
          [ngIfElse]="fallbackTmpl"
          [ngTemplateOutlet]="tmplRef.tmpl"
          [ngTemplateOutletContext]="{ $implicit: tmplRef.data }">
        </ng-template>
          
        <ng-template #fallbackTmpl>
          {{ tmplRef.data.message || 'test' }}
        </ng-template>
      </div>

    </mat-card-content>

  </mat-card>
</ng-template>

<ng-template #lastViewedPointTmpl let-data>
  
  <mat-divider></mat-divider>

  <mat-list class="sxplr-p-0">
    <mat-list-item>
      Last selected spatial object
    </mat-list-item>
  </mat-list>

  <mat-action-list class="sxplr-p-0">
    <ng-template [ngIf]="data?.point">

      <button mat-list-item (click)="selectPoint(data, data.template)">
        <span matListItemIcon>
          <i class="fas fa-history"></i>
        </span>
    
        <!-- <span matListItemLine class="text-muted">Last selected spatial object</span> -->
        <span matListItemLine>{{ data.point | nmToMm | numbers | addUnitAndJoin : '' }} (mm)</span>
        <span matListItemLine class="text-muted">Point</span>
        <span matListItemLine class="text-muted">{{ data.template.name }}</span>
        
      </button>
    </ng-template>

    <ng-template [ngIf]="data?.face && data?.vertices">

      <button mat-list-item (click)="selectPoint(data, data.template)">
        <span matListItemIcon>
          <i class="fas fa-history"></i>
        </span>
    
        <span matListItemLine>
          Face Index: {{ data.face }}, Vertices Index: {{ data.vertices | addUnitAndJoin : '' }}
        </span>
        <span matListItemLine class="text-muted">
          Mesh Face
        </span>
        <span matListItemLine class="text-muted">{{ data.template.name }}</span>
        
      </button>
    </ng-template>
  </mat-action-list>

</ng-template>

<!-- viewer status ctx menu -->
<ng-template #viewerStatusCtxMenu let-data>
  <ng-template [ngIf]="data.context" let-context>

    <!-- ref space & position -->
    <ng-container [ngSwitch]="context.viewerType">

      <!-- volumetric i.e. nehuba -->
      <ng-container *ngSwitchCase="'nehuba'">
        <mat-action-list class="sxplr-p-0">
          <button mat-list-item
            (click)="selectPoint({ point: context.payload.mouse.real }, data.metadata.template)">
            
            <span matListItemIcon>
              <i class="fas fa-map"></i>  
            </span>
            
            <span matListItemLine>
              {{ context.payload.mouse.real | nmToMm | numbers | addUnitAndJoin : '' }} (mm)
            </span>
            <span matListItemLine class="text-muted">
              Point
            </span>
            <span matListItemLine class="text-muted">
              {{ data.metadata.template.name }}
            </span>
          </button>
        </mat-action-list>

      </ng-container>

      <ng-container *ngSwitchCase="'threeSurfer'">

        <ng-template [ngIf]="context.payload?.faceIndex" let-faceIndex>
          <ng-template [ngIf]="context.payload?.vertexIndices" let-vertexIndices>
            <mat-action-list class="sxplr-p-0">
              <button mat-list-item
                (click)="selectPoint({ face: faceIndex, vertices: vertexIndices }, data.metadata.template)"
                disabled>
                
                <span matListItemIcon>
                  <i class="fas fa-map"></i>  
                </span>
                
                <span matListItemLine>
                  Face Index: {{ faceIndex }}, Vertices Index: {{ vertexIndices | addUnitAndJoin : '' }}
                </span>
                <span matListItemLine class="text-muted">
                  Mesh Face (Not selectable for now)
                </span>
                <span matListItemLine class="text-muted">
                  {{ data.metadata.template.name }}
                </span>
              </button>
            </mat-action-list>

          </ng-template>
        </ng-template>
        
      </ng-container>

      <ng-container *ngSwitchDefault>
        DEFAULT
      </ng-container>
    </ng-container>
  </ng-template>
</ng-template>


<!-- viewer state hover ctx menu -->
<ng-template #viewerStatusRegionCtxMenu let-data>
  <!-- hovered ROIs -->
  <ng-template ngFor [ngForOf]="data.metadata.hoveredRegions" let-region>

    <mat-action-list class="sxplr-p-0">
      <button mat-list-item (click)="$event.ctrlKey ? toggleRoi(region) : selectRoi(region)">
        <span matListItemIcon>
          <i class="fas fa-brain"></i>  
        </span>
        
        <span matListItemLine>
          {{ region.name }}
        </span>
        <span matListItemLine class="text-muted">
          Brain region
        </span>
      </button>
    </mat-action-list>

  </ng-template>
</ng-template>

<!-- general point tmpl -->
<ng-template let-view="view" #selectedPointTmpl>
  <sxplr-side-panel>
    <div class="sxplr-custom-cmp lighttheme" header>
      
      <!-- back btn -->
      <button mat-button
        (click)="clearPoint()"
        [attr.aria-label]="ARIA_LABELS.CLOSE"
        class="sxplr-mb-2"
        >
        <span class="ml-1">
          Dismiss
        </span>
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div title>
      {{ view.spatialObjectTitle }}
    </div>
    <div subtitle>
      {{ view.spatialObjectSubtitle }}
    </div>
  </sxplr-side-panel>
  <mat-action-list class="overview-container">
    <ng-template [ngIf]="view.selectedPoint" let-point>
      <ng-template [ngIf]="point | sandsToNum" let-coordinates>
        <button mat-list-item
          (click)="navigateTo(coordinates.coords)"
          matTooltip="Go to coordinate">
          <mat-icon matListItemIcon
            fontSet="fas"
            fontIcon="fa-map-marker">
          </mat-icon>
          <div matListItemTitle>
            {{ coordinates.coords | numbers : 2 | addUnitAndJoin : 'mm' }}
          </div>
        </button>

        <button mat-list-item
          [iav-clipboard-copy]="coordinates.coords | numbers : 2 | addUnitAndJoin : 'mm'"
          matTooltip="Copy coordinate to clipboard">
          <mat-icon matListItemIcon fontSet="fas" fontIcon="fa-copy">
          </mat-icon>
          <div matListItemTitle>
              Copy Coordinates
          </div>
        </button>
      </ng-template>
    </ng-template>
    
  </mat-action-list>

  <mat-divider></mat-divider>

  <sxplr-point-assignment
    [point]="view.selectedPoint"
    [template]="view.selectedTemplate"
    [parcellation]="view.selectedParcellation"
    (clickOnRegionName)="handleClickOnRegionName($event.target, $event.event)">
  </sxplr-point-assignment>
</ng-template>
