<mat-accordion>

    <!-- show everything except for connectivity and dataset -->
    <ng-template ngFor [ngForOf]="cateogryCollections$ | async | keyvalue | filterCategory : ['connectivity', 'dataset', 'other'] : false"  let-keyvalue>
        <ng-template [ngTemplateOutlet]="featureCategoryFeatureTmpl"
        [ngTemplateOutletContext]="{
            $implicit: keyvalue
        }">
        </ng-template>
    </ng-template>
    

    <!-- only show connectivity in human atlas for now -->
    <ng-template [ngIf]="showConnectivity$ | async">
        <ng-template [ngIf]="cateogryCollections$ | async | keyvalue | filterCategory : ['connectivity']" let-connectivity>
            <ng-template ngFor [ngForOf]="connectivity" let-conn>
                <mat-expansion-panel sxplr-sapiviews-features-connectivity-check
                    #connectivityAccordion
                    *ngIf="conn">
                    <mat-expansion-panel-header>
                        <mat-panel-title>
                            {{ conn.key }}
                        </mat-panel-title>
                    </mat-expansion-panel-header>
    
                    <sxplr-features-connectivity-browser class="pe-all flex-shrink-1" 
                        [region]="region"
                        [sxplr-features-connectivity-browser-atlas]="selectedAtlas$ | async"
                        [sxplr-features-connectivity-browser-template]="template"
                        [sxplr-features-connectivity-browser-parcellation]="parcellation"
                        [accordionExpanded]="connectivityAccordion.expanded"
                        [types]="conn.value">
                    </sxplr-features-connectivity-browser>
    
                </mat-expansion-panel>
            </ng-template>
        </ng-template>
    </ng-template>

    <!-- show dataset/other at the very bottom -->
    <ng-template ngFor [ngForOf]="cateogryCollections$ | async | keyvalue | filterCategory : ['dataset', 'other']"  let-keyvalue>
        <ng-template [ngTemplateOutlet]="featureCategoryFeatureTmpl"
        [ngTemplateOutletContext]="{
            $implicit: keyvalue
        }">
        </ng-template>
    </ng-template>
</mat-accordion>

<!-- template for collected category -->
<ng-template #featureCategoryFeatureTmpl let-keyvalue>
    <mat-expansion-panel
        sxplrCategoryAcc
        [unchecked]="filterFeatureCls.unchecked$ | async"
        #categoryAcc="categoryAcc"
        [ngClass]="{
            'sxplr-d-none': !(categoryAcc.isBusy$ | async) && (categoryAcc.total$ | async) === 0
        }">
        <mat-expansion-panel-header>
            <mat-panel-title>
                {{ keyvalue.key }}
            </mat-panel-title>
            <mat-panel-description>
                <ng-template [ngIf]="categoryAcc.total$ | async" let-total>
                    <span>
                        {{ total }}
                    </span>
                </ng-template>
                <spinner-cmp class="sxplr-ml-2 sxplr-d-block" *ngIf="categoryAcc.isBusy$ | async"></spinner-cmp>
            </mat-panel-description>
        </mat-expansion-panel-header>


        <!-- <button mat-button>Show all</button> -->
        <div class="mat-chip-container"
            feature-filter-directive
            [initValue]="true"
            [items]="categoryAcc.featureMetadata$ | async "
            #filterFeatureCls="featureFilterDirective">

            <div class="mat-chip-inner-container">

                <button mat-icon-button matTooltip="Reset filter"
                    (click)="filterFeatureCls.setAll(true)">
                    <i class="fas fa-filter"></i>
                </button>

                <ng-template ngFor [ngForOf]="filterFeatureCls.items" let-grpFeat>
                    <ng-template [ngIf]="grpFeat.meta.total > 0">

                        <ng-template [ngIf]="filterFeatureCls.checked$ | async | grpFeatToName | includes : grpFeat.meta.displayName"
                            [ngIfThen]="selectedTmpl"
                            [ngIfElse]="notSelectedTmpl">
                        </ng-template>

                        <ng-template #textTmpl>
                            <span>
                                {{ grpFeat.meta.displayName }}
                            </span>
                            <span class="text-muted1">
                                ({{ grpFeat.meta.total }})
                            </span>
                        </ng-template>
                        <ng-template #selectedTmpl>
                            <button mat-flat-button
                                (click)="filterFeatureCls.toggle(grpFeat)"
                                color="primary">
                                <i class="fas fa-eye"></i>
                                <ng-template [ngTemplateOutlet]="textTmpl">
                                </ng-template>
                            </button>
                        </ng-template>

                        <ng-template #notSelectedTmpl>
                            <button mat-flat-button
                                (click)="filterFeatureCls.toggle(grpFeat)"
                                color="default">
                                <i class="fas fa-eye-slash"></i>
                                <ng-template [ngTemplateOutlet]="textTmpl">
                                </ng-template>
                            </button>
                        </ng-template>

                    </ng-template>
                </ng-template>
            </div>
        </div>

        <ng-template ngFor [ngForOf]="keyvalue.value" let-feature>

            <!-- collected by CategoryAccDirective with ContentChildren -->
            <div sxplr-feature-list-directive
                [template]="template"
                [parcellation]="parcellation"
                [region]="region"
                [bbox]="bbox"
                [queryParams]="queryParams | mergeObj : { type: (feature.name | featureNamePipe) }"
                [featureRoute]="feature.path"
                [name]="feature.name"
                [displayName]="feature.display_name">
            </div>
        </ng-template>

        <ng-template [ngIf]="categoryAcc.datasource$ | async" let-datasource>
            <cdk-virtual-scroll-viewport itemSize="36"
                (scrolledIndexChange)="onScroll(datasource, $event)"
                class="virtual-scroll-viewport">

                <ng-template cdkVirtualFor
                    [cdkVirtualForOf]="datasource"
                    let-feature
                    let-last="last">

                    <button
                        mat-button
                        class="virtual-scroll-item sxplr-w-100"
                        [matTooltip]="feature.name"
                        matTooltipPosition="right"
                        (click)="onClickFeature(feature)">
                        {{ feature.name }}
                    </button>

                    <div *ngIf="last && datasource.isPulling$ | async">
                        <ng-template [ngTemplateOutlet]="loadingSpinnerTmpl">
                        </ng-template>
                    </div>


                </ng-template>
            </cdk-virtual-scroll-viewport>
        </ng-template>
        
    </mat-expansion-panel>
</ng-template>


<ng-template #loadingSpinnerTmpl>
    <spinner-cmp class="sxplr-pl-2 sxplr-d-block"></spinner-cmp>
</ng-template>
