<div class="d-flex flex-column h-100">
  <viewer-state-controller class="pe-all flex-grow-0 flex-shrink-0 mb-1" #viewerStateController>

    <!-- content append -->
    <ng-container card-content="append">
      <region-text-search-autocomplete
        [showBadge]="true"
        class="d-block w-100">
      </region-text-search-autocomplete>
    </ng-container>

    <!-- footer content -->
    <div class="d-flex flex-row justify-content-center" card-footer>
      <button mat-stroked-button
        *ngIf="!(sidebarMenuState$ | async)?.sidePanelCurrentViewOpened"
        (click)="expandSidePanelCurrentView()"
        class="m-1 flex-grow-1 overflow-hidden" >
        <i class="fas fa-chevron-down"></i>
        <ng-container *ngIf="viewerStateController.regionsSelected$ | async as regionsSelected">
          {{ regionsSelected.length === 0 ? 'Explore the current view' : regionsSelected.length === 1 ? ('Explore ' + regionsSelected[0].name) : ('Explore selected regions (' + regionsSelected.length + ' selected)') }}
        </ng-container>
      </button>
    </div>
  </viewer-state-controller>

  <ng-container *ngIf="(sidebarMenuState$ | async) as sideBarMenu">
    <connectivity-browser class="pe-all flex-grow-5 flex-shrink-1" style="max-height: calc(100% - 220px)"
                          [region]="connectivityRegion"
                          #connectivityBrowser
                          *ngIf="sideBarMenu.sidePanelCurrentViewOpened && sideBarMenu.sidePanelManualCollapsibleView === 'Connectivity'">

    </connectivity-browser>
    <data-browser *ngIf="sideBarMenu.sidePanelCurrentViewOpened && !sideBarMenu.sidePanelManualCollapsibleView"
      class="pe-all flex-grow-5 flex-shrink-1"
      [template]="viewerStateController.templateSelected$ | async"
      [parcellation]="viewerStateController.parcellationSelected$ | async"
      [regions]="viewerStateController.regionsSelected$ | async"
      (dataentriesUpdated)="availableDatasets = $event.length">

      <ng-container card-content='prepend'>
        <ng-container *ngTemplateOutlet="selectedRegionsTmpl">

        </ng-container>

        <mat-divider class="position-relative mt-2 mb-2 mat-divider-full-width"></mat-divider>
      </ng-container>

      <!-- footer content -->
      <div class="d-flex flex-row justify-content-center" card-footer>
        <button mat-stroked-button
          class="m-1"
          (click)="collapseSidePanelCurrentView()" >
          <i class="fas fa-chevron-up"></i>
        </button>
      </div>
    </data-browser>
  </ng-container>

</div>

<div [hidden]>
  <layer-browser
    (nonBaseLayersChanged)="handleNonbaseLayerEvent($event)"
    #layerBrowser>
  </layer-browser>
</div>

<ng-template #layerBrowserTmpl>
  <mat-dialog-content>
    <layer-browser></layer-browser>
  </mat-dialog-content>
</ng-template>

<!-- selected regions container -->
<ng-template #selectedRegionsTmpl>
  <ng-container *ngIf="viewerStateController.regionsSelected$ | async as regionsSelected">
    <div [ngClass]="{'h-117px flex-grow-1': regionsSelected.length > 1, 'flex-grow-0': regionsSelected.length < 2}"
      class="flex-shrink-0 mb-1 pe-all d-flex flex-column">

      <!-- show when no region is selected -->
      <div *ngIf="regionsSelected.length === 0"
        class="pt-2 pb-2 d-flex flex-row align-items-center flex-nowrap">
        <i *ngIf="false" class="fas fa-brain mr-2"></i>

        <small>
          In this parcellation atlas
        </small>
      </div>

      <!-- show when regions are selected -->
      <div *ngIf="regionsSelected.length > 0" class="h-100">

        <!-- single region -->
        <ng-template [ngIf]="regionsSelected.length === 1" [ngIfElse]="multiRegionTemplate">
          
          <small class="text-muted">
            Region selected
          </small>

          <!-- selected brain region -->
          <div class="pt-2 pb-2 d-flex flex-row align-items-center flex-nowrap">
            <i class="fas fa-brain mr-2"></i>

            <small>
              {{ regionsSelected[0].name }}
            </small>

            <button (click)="removeRegion(regionsSelected[0])" mat-icon-button>
              <i class="fas fa-trash"></i>
            </button>
          </div>
        </ng-template>

        <!-- multi region -->
        <ng-template #multiRegionTemplate>
          <div class="h-100 d-flex flex-column">
            <small class="d-block text-muted flex-shrink-0 flex-grow-0">
              {{ regionsSelected.length }} regions selected
            </small>
            <cdk-virtual-scroll-viewport
              class="flex-grow-1 flex-shrink-1"
              itemSize="55"
              maxBufferPx="600"
              minBufferPx="300">
              <div *cdkVirtualFor="let region of regionsSelected; trackBy: trackByFn ; let index = index"
                class="region-wrapper d-flex flex-column" >
                <!-- divider if index !== 0 -->
                <mat-divider class="flex-grow-0 flex-shrink-0" *ngIf="index !== 0"></mat-divider>
  
                <!-- selected brain region -->
                <div class="flex-grow-1 flex-shrink-1 pt-2 pb-2 d-flex flex-row align-items-center flex-nowrap">
                  <i class="flex-grow-0 flex-shrink-0 fas fa-brain mr-2"></i>
      
                  <small class="flex-grow-1 flex-shrink-1 ">
                    {{ region.name }}
                  </small>
      
                  <button mat-icon-button
                    class="flex-grow-0 flex-shrink-0"
                    (click)="removeRegion(region)" >
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              </div>
            </cdk-virtual-scroll-viewport>
          </div>
        </ng-template>

      </div>
    </div>
  </ng-container>
</ng-template>