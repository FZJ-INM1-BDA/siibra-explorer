<mat-card>

  <!-- template selection -->
  <mat-card-content class="d-inline-flex flex-column flex-nowrap w-100">

    <div class="flex-grow-0 flex-shrink-0 d-flex flex-row flex-nowrap">
      <mat-form-field class="flex-grow-1 flex-shrink-1 w-0">
        <mat-label>
          Template
        </mat-label>
        <mat-select
          aria-label="Select a new template"
          panelClass="no-max-width"
          [value]="(templateSelected$ | async)?.name"
          (selectionChange)="handleTemplateChange($event)"
          (openedChange)="focused = $event">
          <mat-option
            *ngFor="let template of (availableTemplates$ | async); trackBy: trackByFn"
            [value]="template.name">
            {{ template.name }}
          </mat-option>
        </mat-select>
      </mat-form-field>
    
      <ng-container *ngIf="templateSelected$ | async as templateSelected">
        <!-- show on hover component -->
        <sleight-of-hand
          class="d-inline-block flex-grow-0 flex-shrink-0"
          *ngIf="templateSelected | templateParcellationHasMoreInfoPipe as moreInfo">
    
          <!-- shown when off -->
          <div sleight-of-hand-front>
            <button
              aria-label="Hover to find out more info on the selected template"
              mat-icon-button>
              <i class="fas fa-info"></i>
            </button>
          </div>
    
          <!-- shown on hover -->
          <div class="d-flex flex-row align-items-start" sleight-of-hand-back>
            <button
              aria-label="Hover to find out more info on the selected template"
              class="flex-grow-0 flex-shrink-0"
              mat-icon-button>
              <i class="fas fa-info"></i>
            </button>
    
            <div class="position-relative">
              <button class="position-relative invisible pe-none" mat-icon-button>
                <i class="fas fa-info"></i>
              </button>
    
              <mat-card *ngFor="let originDataset of moreInfo.originDatasets"
                class="position-absolute left-0 top-0 w-40em">
                <single-dataset-view
                  id="selected-template-detailed-info"
                  [name]="moreInfo.name"
                  [description]="moreInfo.description"
                  [publications]="moreInfo.publications"
                  [kgSchema]="originDataset && originDataset.kgSchema"
                  [kgId]="originDataset && originDataset.kgId">
                </single-dataset-view>
              </mat-card>
            </div>
            
          </div>
        </sleight-of-hand>
    
      </ng-container>
    </div>

    <!-- parcellation selection -->
    <div class="flex-grow-0 flex-shrink-0 d-flex flex-row flex-nowrap">
      <mat-form-field
        *ngIf="templateSelected$ | async as templateSelected"
        class="flex-grow-1 flex-shrink-1 w-0">
        <mat-label>
          Parcellation
        </mat-label>
        <mat-select
          panelClass="no-max-width"
          (selectionChange)="handleParcellationChange($event)"
          [value]="(parcellationSelected$ | async)?.name"
          (openedChange)="focused = $event">
          <mat-option
            *ngFor="let parcellation of (templateSelected.parcellations | appendTooltipTextPipe)"
            [value]="parcellation.name">
            {{ parcellation.displayName || parcellation.name }}
          </mat-option>
        </mat-select>
      </mat-form-field>
    
      <ng-container *ngIf="parcellationSelected$ | async as parcellationSelected">
        <!-- show on hover component -->
        <sleight-of-hand
          class="d-inline-block flex-grow-0 flex-shrink-0"
          *ngIf="parcellationSelected | templateParcellationHasMoreInfoPipe as moreInfo">
    
          <!-- shown when off -->
          <div sleight-of-hand-front>
            <button
              mat-icon-button>
              <i class="fas fa-info"></i>
            </button>
          </div>
    
          <!-- shown on hover -->
          <div class="d-flex flex-row align-items-start" sleight-of-hand-back>
            <button class="flex-grow-0 flex-shrink-0" mat-icon-button>
              <i class="fas fa-info"></i>
            </button>
    
            <div class="position-relative">
              <button class="position-relative invisible pe-none" mat-icon-button>
                <i class="fas fa-info"></i>
              </button>
    
              <mat-card *ngFor="let originDataset of moreInfo.originDatasets"
                class="position-absolute left-0 top-0 w-40em">

                <single-dataset-view
                  [name]="moreInfo.name"
                  [description]="moreInfo.description"
                  [publications]="moreInfo.publications"
                  [kgSchema]="originDataset && originDataset.kgSchema"
                  [kgId]="originDataset && originDataset.kgId">
                </single-dataset-view>
              </mat-card>
            </div>
          </div>
        </sleight-of-hand>
      </ng-container>
    </div>

    <div class="flex-grow-1 flex-shrink-0">
      <ng-content select="[card-content='append']">
      </ng-content>
    </div>
  </mat-card-content>


  <mat-card-footer>
    <ng-content select="[card-footer]">
    </ng-content>
  </mat-card-footer>
</mat-card>

<!-- bottom sheet for saved regions  -->
<ng-template #savedRegionBottomSheetTemplate>
  <mat-action-list>

    <!-- separated (binned) by template/parcellation -->
    <ng-container *ngFor="let binnedRS of (savedRegionsSelections$ | async | binSavedRegionsSelectionPipe); let index = index">

      <!-- only render divider if it is not the leading element -->
      <mat-divider *ngIf="index !== 0"></mat-divider>

      <!-- header -->
      <h3 mat-subheader>
        {{ binnedRS.templateSelected.name }} / {{ binnedRS.parcellationSelected.name }}
      </h3>

      <!-- ng for all saved regions -->
      <button
        *ngFor="let savedRegionsSelection of binnedRS.regionSelections"
        (click)="loadSavedRegion($event, savedRegionsSelection)"
        mat-list-item>
        <!-- [class]="savedRegionsSelection | savedRegionsSelectionBtnDisabledPipe : (templateSelected$ | async) : (parcellationSelected$ | async) ? 'text-muted' : ''" -->
        <!-- [disabled]="savedRegionsSelection | savedRegionsSelectionBtnDisabledPipe : (templateSelected$ | async) : (parcellationSelected$ | async)" -->
        <!-- main content -->
        <span class="flex-grow-0 flex-shrink-1">
          {{ savedRegionsSelection.name }}
        </span>
        <small class="ml-1 mr-1 text-muted flex-grow-1 flex-shrink-0">
          ({{ savedRegionsSelection.regionsSelected.length }} selected regions)
        </small>

        <!-- edit btn -->
        <button
          (mousedown)="$event.stopPropagation()"
          (click)="editSavedRegion($event, savedRegionsSelection)"
          mat-icon-button>
          <i class="fas fa-edit"></i>
        </button>

        <!-- trash btn -->
        <button
          (mousedown)="$event.stopPropagation()"
          (click)="removeSavedRegion($event, savedRegionsSelection)"
          mat-icon-button
          color="warn">
          <i class="fas fa-trash"></i>
        </button>
      </button>
    </ng-container>
  </mat-action-list>
</ng-template>