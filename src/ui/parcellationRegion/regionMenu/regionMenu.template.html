<mat-card>
  <!-- rgbDarkmode must be checked for strict equality to true/false 
  as if rgb is undefined, rgbDarkmode will be null/undefined
  which is falsy -->
  <div class="header-container"
    [ngClass]="{'darktheme': rgbDarkmode === true, 'lighttheme': rgbDarkmode === false}"
    [style.backgroundColor]="rgbString">
    <mat-card-title>
      <div class="position-relative region-name iv-custom-comp text">
        {{ region.name }}
        <small *ngIf="region.status"> ({{region.status}})</small>
      </div>
    </mat-card-title>

    <!-- other info about brain region -->
    <mat-card-subtitle class="mb-0 ml-5-n mr-5-n">

      <!-- origin datas -->
      <button mat-button 
        [color]="previewDirective.active ? 'primary' : 'basic'"
        *ngFor="let originDataset of (region.originDatasets || []); let index = index"
        iav-dataset-preview-dataset-file
        [iav-dataset-preview-dataset-file-kgid]="originDataset.kgId"
        [iav-dataset-preview-dataset-file-filename]="originDataset.filename"
        #previewDirective="iavDatasetPreviewDatasetFile"
        iv-custom-comp
        [attr.primary]="previewDirective.active || null"
        role="switch"
        [attr.aria-checked]="previewDirective.active"
        [attr.aria-label]="SHOW_ORIGIN_DATASET">
        <mat-icon fontSet="fas" fontIcon="fa-eye"></mat-icon>
        <span>
          View {{ regionOriginDatasetLabels$ | async | renderViewOriginDatasetlabel : index }}
        </span>
      </button>

      <!-- position -->
      <button mat-icon-button *ngIf="region?.position"
        (click)="navigateToRegion()"
        [matTooltip]="region.position | nmToMm | addUnitAndJoin : 'mm'">
        <mat-icon fontSet="fas" fontIcon="fa-map-marked-alt">
        </mat-icon>
      </button>
    </mat-card-subtitle>
  </div>

  <mat-card-content>
    <mat-divider></mat-divider>

    <!-- region desc -->
    <ng-container *ngIf="region?.description?.length > 0">
      <mat-divider></mat-divider>
      <div>
        {{ region.description }}
    </div>
    </ng-container>

    <mat-divider></mat-divider>

    <mat-list class="action-list sm cursor-default">

      <!-- connectivity -->
      <div *ngIf="hasConnectivity" iav-switch #connectivitySwitch="iavSwitch">

        <mat-list-item mat-ripple
          (click)="connectivitySwitch.toggle()"
          [attr.aria-label]="SHOW_CONNECTIVITY_DATA">
          <mat-icon fontSet="fab" fontIcon="fa-connectdevelop" mat-list-icon></mat-icon >
          <div mat-line>
            <span>
              Connectivity
            </span>
            <span class="muted">
             ({{ 1 }})
            </span>
          </div>
          <mat-icon fontSet="fas" [fontIcon]="connectivitySwitch.switchState ? 'fa-chevron-up' : 'fa-chevron-down'"></mat-icon>
        </mat-list-item>

        <!-- connectivity -->
        <mat-list-item *ngIf="connectivitySwitch.switchState" mat-ripple (click)="showConnectivity(region.name)">
          <mat-icon fontSet="fas" fontIcon="fa-none" mat-list-icon></mat-icon>
          <div mat-line>1000 Brain Study - DTI connectivity</div>
        </mat-list-item>

      </div>

      <!-- change template -->
      <ng-container *ngIf="showRegionInOtherTmpl">
        <ng-container *ngTemplateOutlet="regionInOtherTemplatesTmpl; context: { regionInOtherTemplates: regionInOtherTemplates$ | async }">
        </ng-container>
      </ng-container>

    </mat-list>
  </mat-card-content>
</mat-card>

<!-- ToDo make dynamic with AVAILABLE CONNECTIVITY DATASETS data - get info from atlas viewer core -->
<mat-menu
  #connectivitySourceDatasets="matMenu"
  xPosition="before"
  hasBackdrop="false">
  <div>
    <button mat-menu-item (mousedown)="showConnectivity(region.name)">
      <span>1000 Brain Study - DTI connectivity</span>
    </button>
  </div>
</mat-menu>

<!-- template for switching template -->
<ng-template #regionInOtherTemplatesTmpl let-regionInOtherTemplates="regionInOtherTemplates">

  <div iav-switch #changeTmplSwitch="iavSwitch">

    <mat-list-item *ngIf="regionInOtherTemplates.length"
      mat-ripple
      [attr.aria-label]="SHOW_IN_OTHER_REF_SPACE"
      (click)="changeTmplSwitch && changeTmplSwitch.toggle()">
      <mat-icon fontSet="fas" fontIcon="fa-brain" mat-list-icon></mat-icon>
      <div mat-line>
        <span>
          Explore in other templates
        </span>
        <span class="muted">
          ({{ regionInOtherTemplates.length }})
        </span>
      </div>
      <mat-icon fontSet="fas" [fontIcon]="changeTmplSwitch.switchState ? 'fa-chevron-up' : 'fa-chevron-down'"></mat-icon>
    </mat-list-item>

    <!-- change template items -->
    <div *ngIf="changeTmplSwitch.switchState"
      [attr.aria-label]="AVAILABILITY_IN_OTHER_REF_SPACE">
      <mat-list-item *ngFor="let sameRegion of regionInOtherTemplates; let i = index"
        [attr.aria-label]="SHOW_IN_OTHER_REF_SPACE + ': ' + sameRegion.template.name + (sameRegion.hemisphere ? (' - ' + sameRegion.hemisphere) : '') "
        (click)="changeView(sameRegion)"
        mat-ripple
        [attr.role]="'button'">
        <mat-icon fontSet="fas" fontIcon="fa-none" mat-list-icon></mat-icon>
        <div mat-line>
          <ng-container *ngTemplateOutlet="regionInOtherTemplate; context: sameRegion">
          </ng-container>
        </div>
      </mat-list-item>
    </div>
  </div>
</ng-template>

<!-- template for rendering template name and template hemisphere -->
<ng-template #regionInOtherTemplate let-template="template" let-hemisphere="hemisphere">
  <span class="overflow-x-hidden text-truncate"
  [matTooltip]="template.name  + (hemisphere ? (' ' + hemisphere) : '')">
    <span>
      {{ template.name }}
    </span>
    <span *ngIf="hemisphere" class="text-muted">
      ({{ hemisphere }})
    </span>
  </span>
</ng-template>
